<!DOCTYPE html>
<html lang="ru">
	<head>
		<title>Поздравлялка</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<!-- <link href="style.css" rel="stylesheet"> -->
		<script src="https://vk.com/js/api/xd_connection.js?2"  type="text/javascript"></script>
		<style>
			* {
				box-sizing: border-box;
			}
			
			html, body {
				height: 100%;
				width: 100%;
			}
			
			body {
				margin: 0;
				padding: 8px;
			}
			
			.container {
				height: 90%;
				overflow: auto;
			}
			
			.btn-container {
				height: 10%;
				background-color: lightblue;
				display: flex;
				justify-content: center;
				align-items: center;
			}
			
			label {
				display: inline-block;
				height: 100px;
				width: 100px;
				position: relative;
			}
			
			input[data-photo-id] {
				position: absolute;
				top: 5px;
				right: 5px;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<!-- <button id="make-post-btn" style="display: none;" onclick="makePost()">Разместить пост</button> -->
			<p>Выберите группу, в которой будет размещено поздравление.</p>
			<select id="groups">
			</select>
			<p>Выберите дату и время размещения поста.</p>
			<input id="post-date" type="datetime-local" onchange="changePostDateTime()">
			<p>Текст поздравления.</p>
			<textarea id="text" cols="60" rows="15"></textarea><br><br>
			<button onclick="showUsers(groups.value, postMonth, postDate)">Показать именинников</button><br><br>
			<div id="users-photos"></div><br><br>
		</div>
		<div class="btn-container">
			<button id="make-post-btn" onclick="makePost()" disabled>Разместить пост</button>
		</div>
	</body>
	<script>
		'use strict';
		const groups = document.getElementById('groups');
		const text = document.getElementById('text');
		const usersPhotos = document.getElementById('users-photos');
		const makePostBtn = document.getElementById('make-post-btn');
		const defaultPostDateTime = new Date();
		defaultPostDateTime.setDate(defaultPostDateTime.getDate() + 1);
		const defaultPostYear = defaultPostDateTime.getFullYear();
		const defaultPostMonth = defaultPostDateTime.getMonth() + 1;
		const defaultPostDate = defaultPostDateTime.getDate();
		let postYear = defaultPostYear;
		let postMonth = defaultPostMonth;
		let postDate = defaultPostDate;
		let attachments = [];

		const staticText = 'Сегодня мы спешим поздравить наших сообщников с ДНЕМ РОЖДЕНИЯ!!!\n\n';
		text.innerHTML = staticText;

		VK.init(function() {
			VK.api("groups.get", {"extended": "1", 'count':300, 'filter': 'moder'}, function (data) {

					//console.log(data.response); 
					// по умолчанию на завтра
				   //  var now = new Date();
					// var d = now.getDate() +1; //alert(d);
					// var m = now.getMonth()+1; //alert(m);


				   //  document.getElementById('result1').innerHTML =
				   //  'Введите id сообщества в котором хотите поздравить именнинников:' + '<br><br><input id="gr_id" value="128570542">' 
				   //  +
				   //  'и дату: <input id="day3" value="'+d+'" style="width:15px;">.<input id="month3" value="'+m+'" style="width:15px;"> '
				   //  +
				   //  '<input type="button" value="Поехали" onclick="get_users(document.getElementById(\'gr_id\').value)"><br><br><br>' +
				   //   'Или выберите сообщество (доступны только те сообщества, которые видны у вас всем):<br>';

				   //  var out = '';
				   //  for (var i in data.response.items) {
				   //      out += i + ": " + data.response.items[i].name + '<a href="#" onclick="get_users(' + data.response.items[i].id + ')">Выбрать</a><br>';

				   //  }
				   //  out_end = '<br><br>';

				   //  document.getElementById('result1').innerHTML += out + out_end;
				  // document.write(JSON.stringify(data));

				data.response.items.forEach( (item) => {
					let elem = document.createElement('option');
					elem.innerHTML = item.name;
					elem.setAttribute('value', item.id);
					groups.appendChild(elem);

				});	

				// getUsers(groups.value, defaultPostMonth, defaultPostDate)

			});
		}, function() {
			document.write('Ошибка инициализации приложения!! Обратитесь к разработчику приложения или обновите страницу.');
		}, '5.131');

		document.getElementById('post-date').value = defaultPostYear + '-' + defaultPostMonth.toString().padStart(2,0) + 
			'-' + defaultPostDate.toString().padStart(2,0) + 'T09:00';

		function changePostDateTime() {
			let dateTime = document.getElementById('post-date').value;
			postYear = +dateTime.slice(0, 4);
			postMonth = +dateTime.slice(5, 7);
			postDate = +dateTime.slice(8, 10);
			console.log(postMonth);
		}

		function showUsers(groupId, month, date) {

			VK.init(function() {
				VK.api("users.search", {group_id: groupId, /*birth_day: date,*/ birth_month: month, count:1000, fields: 'photo_id,photo_100'}, function (data) {


						// document.getElementById('result2').innerHTML = 
						// 'Сегодня мы спешим поздравить наших сообщников с ДНЕМ РОЖДЕНИЯ!!! ' + "\r\n" + '';


						// var out = '';
						// var attachments = '';
						// var photos = '';
						// for (var i in data2.response.items) {
						// 	//y=i+1;
						//     out += ' [id'+data2.response.items[i].id+'|' + data2.response.items[i].first_name + ' '+data2.response.items[i].last_name+ 
						//     '] '+

						//     '';
						//     if(data2.response.items[i].photo_id != "undefined") {
						//     	attachments += 'photo'+data2.response.items[i].photo_id +',';
						//     	photos += '<a target="_blank" href="'+data2.response.items[i].photo_200+'"><img src="'+data2.response.items[i].photo_200 +'" alt="" width="75"></a>';
						//     }

						// }
						// document.getElementById('result2').innerHTML += out;
						// document.getElementById('photos').innerHTML += photos;
						// document.getElementById('attachments').innerHTML += attachments;

					// let usersList = '';
					let usersList = [];
					let usersPhotosList = [];
					// attachments = [];

					data.response.items.forEach(function (user) {
						console.log(JSON.stringify(user));
						// console.log(user.bdate);
						let userInfo = '[id' + user.id + '|' + user.first_name + ' ' + user.last_name + ']';
						// console.log(userInfo);
						// text.innerHTML += userInfo + ' ';
						// usersList += userInfo + ' ';
						usersList.push(userInfo);
						let userPhoto = '<label><img src="' + user.photo_100 + '"><input type="checkbox" data-photo-id="photo' + 
							user.photo_id + '" checked></label>';
						// usersPhotos.innerHTML += userPhoto;
						usersPhotosList.push(userPhoto);
						let attachment = 'photo' + user.photo_id;
						attachments.push(attachment);
					});

					text.innerHTML = staticText + usersList.join(' ');
					usersPhotos.innerHTML = usersPhotosList.join('');

					if (data.response.items.length > 0)
						makePostBtn.disabled = false;
					else {
						makePostBtn.disabled = true;
					}

				});
			}, function() {
				document.write('Ошибка инициализации приложения!! Обратитесь к разработчику приложения или обновите страницу.');
			}, '5.131');

		}

		function makePost() {
			let publish_date = Date.parse( document.getElementById('post-date').value ) / 1000;
			console.log('Data publicacii' + publish_date );
			attachments = [];

			document.querySelectorAll('input[data-photo-id]').forEach((elem) => {
				if (elem.checked == true) {
					attachments.push(elem.getAttribute('data-photo-id'));
				}
			});

			VK.init(function() {
				VK.api("wall.post", {owner_id: '-' + groups.value, from_group: 1, publish_date: publish_date,
					message: text.innerHTML, attachments: attachments.join(',')});
			}, function() {
				document.write('Ошибка инициализации приложения!! Обратитесь к разработчику приложения или обновите страницу.');
			}, '5.131');
		}

	</script>
</html>
